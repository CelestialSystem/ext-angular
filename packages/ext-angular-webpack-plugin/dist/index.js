'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

class ExtWebpackPlugin {
  constructor(options) {
    this.plugin = require(`./pluginUtil`)._constructor(options);
  }

  apply(compiler) {
    require('./pluginUtil').logv(this.plugin.options, 'FUNCTION apply');

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      require('./pluginUtil').logv(this.plugin.options, 'HOOK thisCompilation');

      if (this.plugin.vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(this.plugin.vars.pluginErrors.join("")));
      }
    });

    if (this.plugin.vars.pluginErrors.length > 0) {
      return;
    }

    if (this.plugin.vars.framework == 'extjs') {
      compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK compilation');
      });
      compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK afterCompile');

        require(`./extjsUtil`)._afterCompile(compilation, this.plugin.vars, this.plugin.options);
      });
    } else {
      compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK compilation');

        require(`./pluginUtil`)._compilation(compiler, compilation, this.plugin.vars, this.plugin.options);
      });
      compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK afterCompile');

        require(`./pluginUtil`)._afterCompile(compiler, compilation, this.plugin.vars, this.plugin.options);
      });
    }

    if (this.plugin.options.genProdData == true && this.plugin.options.environment == 'production' || this.plugin.options.genProdData == false && this.plugin.options.environment != 'production') {
      compiler.hooks.emit.tapAsync(`ext-emit`, (compilation, callback) => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK emit');

        require(`./pluginUtil`).emit(compiler, compilation, this.plugin.vars, this.plugin.options, callback);
      });
    }

    compiler.hooks.done.tap(`ext-done`, () => {
      require('./pluginUtil').logv(this.plugin.options, 'HOOK done');

      if (this.plugin.vars.production && !this.plugin.options.genProdData && this.plugin.options.framework == 'angular') {
        const path = require('path');

        const fsx = require('fs-extra');

        var rimraf = require("rimraf");

        rimraf.sync(path.resolve(process.cwd(), `src/app/ext-angular-prod`));

        try {
          const appModulePath = path.resolve(process.cwd(), 'src/app/app.module.ts');
          var js = fsx.readFileSync(appModulePath).toString();
          var newJs = js.replace(`import { ExtAngularModule } from './ext-angular-prod/ext-angular.module'`, `import { ExtAngularModule } from '@sencha/ext-angular'`);
          fsx.writeFileSync(appModulePath, newJs, 'utf-8', () => {
            return;
          });
        } catch (e) {
          console.log(e);
          compilation.errors.push('replace ExtAngularModule - ext-done: ' + e);
          return [];
        }
      }

      try {
        if (this.plugin.options.browser == true && this.plugin.options.watch == 'yes' && this.plugin.vars.production == false) {
          if (this.plugin.vars.browserCount == 0) {
            var url = 'http://localhost:' + this.plugin.options.port;

            require('./pluginUtil').log(this.plugin.vars.app + `Opening browser at ${url}`);

            this.plugin.vars.browserCount++;

            const opn = require('opn');

            opn(url);
          }
        }
      } catch (e) {
        console.log(e);
        compilation.errors.push('show browser window - ext-done: ' + e);
      }

      require('./pluginUtil').log(this.plugin.vars.app + `Completed ext-webpack-plugin processing`);
    });
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiRXh0V2VicGFja1BsdWdpbiIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsInBsdWdpbiIsIl9jb25zdHJ1Y3RvciIsImFwcGx5IiwiY29tcGlsZXIiLCJsb2d2IiwiaG9va3MiLCJjb25zb2xlIiwibG9nIiwidGhpc0NvbXBpbGF0aW9uIiwidGFwIiwiY29tcGlsYXRpb24iLCJ2YXJzIiwicGx1Z2luRXJyb3JzIiwibGVuZ3RoIiwiZXJyb3JzIiwicHVzaCIsIkVycm9yIiwiam9pbiIsImZyYW1ld29yayIsImFmdGVyQ29tcGlsZSIsIl9hZnRlckNvbXBpbGUiLCJfY29tcGlsYXRpb24iLCJnZW5Qcm9kRGF0YSIsImVudmlyb25tZW50IiwiZW1pdCIsInRhcEFzeW5jIiwiY2FsbGJhY2siLCJkb25lIiwicHJvZHVjdGlvbiIsInBhdGgiLCJmc3giLCJyaW1yYWYiLCJzeW5jIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJjd2QiLCJhcHBNb2R1bGVQYXRoIiwianMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsIm5ld0pzIiwicmVwbGFjZSIsIndyaXRlRmlsZVN5bmMiLCJlIiwiYnJvd3NlciIsIndhdGNoIiwiYnJvd3NlckNvdW50IiwidXJsIiwicG9ydCIsImFwcCIsIm9wbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFDQUEsT0FBTyxDQUFDLGlCQUFELENBQVA7O0FBRWUsTUFBTUMsZ0JBQU4sQ0FBdUI7QUFFcENDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVO0FBQ25CLFNBQUtDLE1BQUwsR0FBY0osT0FBTyxDQUFFLGNBQUYsQ0FBUCxDQUF3QkssWUFBeEIsQ0FBcUNGLE9BQXJDLENBQWQ7QUFDRDs7QUFFREcsRUFBQUEsS0FBSyxDQUFDQyxRQUFELEVBQVc7QUFDZFAsSUFBQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QlEsSUFBeEIsQ0FBNkIsS0FBS0osTUFBTCxDQUFZ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Y0FBSSxLQUFLNUIsTUFBTCxDQUFZVyxJQUFaLENBQWlCbUMsWUFBakIsSUFBaUMsQ0FBckMsRUFBd0M7QUFDdEMsZ0JBQUlDLEdBQUcsR0FBRyxzQkFBc0IsS0FBSy9DLE1BQUwsQ0FBWUQsT0FBWixDQUFvQmlELElBQXBEOztBQUNBcEQsWUFBQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QlcsR0FBeEIsQ0FBNEIsS0FBS1AsTUFBTCxDQUFZVyxJQUFaLENBQWlCc0MsR0FBakIsR0FBd0Isc0JBQXFCRixHQUFJLEVBQTdFOztBQUNBLGlCQUFLL0MsTUFBTCxDQUFZVyxJQUFaLENBQWlCbUMsWUFBakI7O0FBQ0Esa0JBQU1JLEdBQUcsR0FBR3RELE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUNBc0QsWUFBQUEsR0FBRyxDQUFDSCxHQUFELENBQUg7QUFDRDtBQUNGO0FBQ0YsT0FWRCxDQVdBLE9BQU9KLENBQVAsRUFBVTtBQUNSckMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlvQyxDQUFaO0FBQ0FqQyxRQUFBQSxXQUFXLENBQUNJLE1BQVosQ0FBbUJDLElBQW5CLENBQXdCLHFDQUFxQzRCLENBQTdEO0FBQ0Q7O0FBQ0QvQyxNQUFBQSxPQUFPLENBQUMsY0FBRCxDQUFQLENBQXdCVyxHQUF4QixDQUE0QixLQUFLUCxNQUFMLENBQVlXLElBQVosQ0FBaUJzQyxHQUFqQixHQUF3Qix5Q0FBcEQ7QUFDRCxLQXhDRDtBQTBDRDs7QUEzRm1DIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5yZXF1aXJlKCdAYmFiZWwvcG9seWZpbGwnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFeHRXZWJwYWNrUGx1Z2luIHtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgdGhpcy5wbHVnaW4gPSByZXF1aXJlKGAuL3BsdWdpblV0aWxgKS5fY29uc3RydWN0b3Iob3B0aW9ucylcbiAgfVxuXG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdGVU5DVElPTiBhcHBseScpXG4gICAgaWYgKCFjb21waWxlci5ob29rcykge2NvbnNvbGUubG9nKCdub3Qgd2VicGFjayA0Jyk7cmV0dXJufVxuXG4gICAgY29tcGlsZXIuaG9va3MudGhpc0NvbXBpbGF0aW9uLnRhcChgZXh0LXRoaXMtY29tcGlsYXRpb25gLCAoY29tcGlsYXRpb24pID0+IHtcbiAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3YodGhpcy5wbHVnaW4ub3B0aW9ucywnSE9PSyB0aGlzQ29tcGlsYXRpb24nKVxuICAgICAgaWYgKHRoaXMucGx1Z2luLnZhcnMucGx1Z2luRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29tcGlsYXRpb24uZXJyb3JzLnB1c2goIG5ldyBFcnJvcih0aGlzLnBsdWdpbi52YXJzLnBsdWdpbkVycm9ycy5qb2luKFwiXCIpKSApXG4gICAgICB9XG4gICAgfSlcbiAgICBpZiAodGhpcy5wbHVnaW4udmFycy5wbHVnaW5FcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKCB0aGlzLnBsdWdpbi52YXJzLmZyYW1ld29yayA9PSAnZXh0anMnKSB7XG4gICAgICBjb21waWxlci5ob29rcy5jb21waWxhdGlvbi50YXAoYGV4dC1jb21waWxhdGlvbmAsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2KHRoaXMucGx1Z2luLm9wdGlvbnMsJ0hPT0sgY29tcGlsYXRpb24nKVxuICAgICAgfSlcbiAgICAgIGNvbXBpbGVyLmhvb2tzLmFmdGVyQ29tcGlsZS50YXAoJ2V4dC1hZnRlci1jb21waWxlJywgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3YodGhpcy5wbHVnaW4ub3B0aW9ucywnSE9PSyBhZnRlckNvbXBpbGUnKVxuICAgICAgICByZXF1aXJlKGAuL2V4dGpzVXRpbGApLl9hZnRlckNvbXBpbGUoY29tcGlsYXRpb24sIHRoaXMucGx1Z2luLnZhcnMsIHRoaXMucGx1Z2luLm9wdGlvbnMpXG4gICAgICB9KVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGNvbXBpbGVyLmhvb2tzLmNvbXBpbGF0aW9uLnRhcChgZXh0LWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3YodGhpcy5wbHVnaW4ub3B0aW9ucywnSE9PSyBjb21waWxhdGlvbicpXG4gICAgICAgIHJlcXVpcmUoYC4vcGx1Z2luVXRpbGApLl9jb21waWxhdGlvbihjb21waWxlciwgY29tcGlsYXRpb24sIHRoaXMucGx1Z2luLnZhcnMsIHRoaXMucGx1Z2luLm9wdGlvbnMpXG4gICAgICB9KVxuICAgICAgY29tcGlsZXIuaG9va3MuYWZ0ZXJDb21waWxlLnRhcCgnZXh0LWFmdGVyLWNvbXBpbGUnLCAoY29tcGlsYXRpb24pID0+IHtcbiAgICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIGFmdGVyQ29tcGlsZScpXG4gICAgICAgIHJlcXVpcmUoYC4vcGx1Z2luVXRpbGApLl9hZnRlckNvbXBpbGUoY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB0aGlzLnBsdWdpbi52YXJzLCB0aGlzLnBsdWdpbi5vcHRpb25zKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBpZigodGhpcy5wbHVnaW4ub3B0aW9ucy5nZW5Qcm9kRGF0YSA9PSB0cnVlICYmIHRoaXMucGx1Z2luLm9wdGlvbnMuZW52aXJvbm1lbnQgPT0gJ3Byb2R1Y3Rpb24nKSB8fFxuICAgICAgICh0aGlzLnBsdWdpbi5vcHRpb25zLmdlblByb2REYXRhID09IGZhbHNlICYmIHRoaXMucGx1Z2luLm9wdGlvbnMuZW52aXJvbm1lbnQgIT0gJ3Byb2R1Y3Rpb24nKSlcbiAgICB7XG4gICAgICBjb21waWxlci5ob29rcy5lbWl0LnRhcEFzeW5jKGBleHQtZW1pdGAsIChjb21waWxhdGlvbiwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIGVtaXQnKVxuICAgICAgICByZXF1aXJlKGAuL3BsdWdpblV0aWxgKS5lbWl0KGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdGhpcy5wbHVnaW4udmFycywgdGhpcy5wbHVnaW4ub3B0aW9ucywgY2FsbGJhY2spXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbXBpbGVyLmhvb2tzLmRvbmUudGFwKGBleHQtZG9uZWAsICgpID0+IHtcbiAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3YodGhpcy5wbHVnaW4ub3B0aW9ucywnSE9PSyBkb25lJylcblxuICAgICAgaWYgKHRoaXMucGx1Z2luLnZhcnMucHJvZHVjdGlvbiAmJiAhdGhpcy5wbHVnaW4ub3B0aW9ucy5nZW5Qcm9kRGF0YSAmJiB0aGlzLnBsdWdpbi5vcHRpb25zLmZyYW1ld29yayA9PSAnYW5ndWxhcicpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuICAgICAgICBjb25zdCBmc3ggPSByZXF1aXJlKCdmcy1leHRyYScpXG4gICAgICAgIHZhciByaW1yYWYgPSByZXF1aXJlKFwicmltcmFmXCIpO1xuICAgICAgICByaW1yYWYuc3luYyhwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgYHNyYy9hcHAvZXh0LWFuZ3VsYXItcHJvZGApKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBhcHBNb2R1bGVQYXRoID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICdzcmMvYXBwL2FwcC5tb2R1bGUudHMnKVxuICAgICAgICAgIHZhciBqcyA9IGZzeC5yZWFkRmlsZVN5bmMoYXBwTW9kdWxlUGF0aCkudG9TdHJpbmcoKVxuICAgICAgICAgIHZhciBuZXdKcyA9IGpzLnJlcGxhY2UoXG4gICAgICAgICAgICBgaW1wb3J0IHsgRXh0QW5ndWxhck1vZHVsZSB9IGZyb20gJy4vZXh0LWFuZ3VsYXItcHJvZC9leHQtYW5ndWxhci5tb2R1bGUnYCxcbiAgICAgICAgICAgIGBpbXBvcnQgeyBFeHRBbmd1bGFyTW9kdWxlIH0gZnJvbSAnQHNlbmNoYS9leHQtYW5ndWxhcidgXG4gICAgICAgICAgKTtcbiAgICAgICAgICBmc3gud3JpdGVGaWxlU3luYyhhcHBNb2R1bGVQYXRoLCBuZXdKcywgJ3V0Zi04JywgKCk9PntyZXR1cm59KVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgICBjb21waWxhdGlvbi5lcnJvcnMucHVzaCgncmVwbGFjZSBFeHRBbmd1bGFyTW9kdWxlIC0gZXh0LWRvbmU6ICcgKyBlKVxuICAgICAgICAgIHJldHVybiBbXVxuICAgICAgICB9XG4gICAgICB9IFxuXG4gICAgICB0cnkge1xuICAgICAgICBpZih0aGlzLnBsdWdpbi5vcHRpb25zLmJyb3dzZXIgPT0gdHJ1ZSAmJiB0aGlzLnBsdWdpbi5vcHRpb25zLndhdGNoID09ICd5ZXMnICYmIHRoaXMucGx1Z2luLnZhcnMucHJvZHVjdGlvbiA9PSBmYWxzZSkge1xuICAgICAgICAgIGlmICh0aGlzLnBsdWdpbi52YXJzLmJyb3dzZXJDb3VudCA9PSAwKSB7XG4gICAgICAgICAgICB2YXIgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6JyArIHRoaXMucGx1Z2luLm9wdGlvbnMucG9ydFxuICAgICAgICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9nKHRoaXMucGx1Z2luLnZhcnMuYXBwICsgYE9wZW5pbmcgYnJvd3NlciBhdCAke3VybH1gKVxuICAgICAgICAgICAgdGhpcy5wbHVnaW4udmFycy5icm93c2VyQ291bnQrK1xuICAgICAgICAgICAgY29uc3Qgb3BuID0gcmVxdWlyZSgnb3BuJylcbiAgICAgICAgICAgIG9wbih1cmwpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICBjb21waWxhdGlvbi5lcnJvcnMucHVzaCgnc2hvdyBicm93c2VyIHdpbmRvdyAtIGV4dC1kb25lOiAnICsgZSlcbiAgICAgIH1cbiAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZyh0aGlzLnBsdWdpbi52YXJzLmFwcCArIGBDb21wbGV0ZWQgZXh0LXdlYnBhY2stcGx1Z2luIHByb2Nlc3NpbmdgKVxuICAgIH0pXG5cbiAgfVxufVxuIl19