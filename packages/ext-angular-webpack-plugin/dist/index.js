'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

class ExtWebpackPlugin {
  constructor(options) {
    this.plugin = require(`./pluginUtil`)._constructor(options);
  }

  apply(compiler) {
    require('./pluginUtil').logv(this.plugin.options, 'FUNCTION apply');

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      require('./pluginUtil').logv(this.plugin.options, 'HOOK thisCompilation');

      if (this.plugin.vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(this.plugin.vars.pluginErrors.join("")));
      }
    });

    if (this.plugin.vars.pluginErrors.length > 0) {
      return;
    }

    if (this.plugin.vars.framework == 'extjs') {
      compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK compilation');
      });
      compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK afterCompile');

        require(`./extjsUtil`)._afterCompile(compilation, this.plugin.vars, this.plugin.options);
      });
    } else {
      compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK compilation');

        require(`./pluginUtil`)._compilation(compiler, compilation, this.plugin.vars, this.plugin.options);
      });
      compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK afterCompile');

        require(`./pluginUtil`)._afterCompile(compiler, compilation, this.plugin.vars, this.plugin.options);
      });
    }

    if (this.plugin.options.genProdData == true && this.plugin.options.environment == 'production' || this.plugin.options.genProdData == false && this.plugin.options.environment != 'production') {
      compiler.hooks.emit.tapAsync(`ext-emit`, (compilation, callback) => {
        require('./pluginUtil').logv(this.plugin.options, 'HOOK emit');

        require(`./pluginUtil`).emit(compiler, compilation, this.plugin.vars, this.plugin.options, callback);
      });
    }

    compiler.hooks.done.tap(`ext-done`, () => {
      require('./pluginUtil').logv(this.plugin.options, 'HOOK done');

      if (this.plugin.vars.production && !this.plugin.options.genProdData && this.plugin.options.framework == 'angular') {
        const path = require('path');

        const fsx = require('fs-extra');

        var rimraf = require("rimraf");

        rimraf.sync(path.resolve(process.cwd(), `src/app/ext-angular-prod`));

        try {
          const appModulePath = path.resolve(process.cwd(), 'src/app/app.module.ts');
          var js = fsx.readFileSync(appModulePath).toString();
          var newJs = js.replace(`import { ExtAngularModule } from './ext-angular-prod/ext-angular.module'`, `import { ExtAngularModule } from '@sencha/ext-angular'`);
          fsx.writeFileSync(appModulePath, newJs, 'utf-8', () => {
            return;
          });
        } catch (e) {
          console.log(e);
          compilation.errors.push('replace ExtAngularModule - ext-done: ' + e);
          return [];
        }
      }

      try {
        if (this.plugin.options.browser == true && this.plugin.options.watch == 'yes' && this.plugin.vars.production == false) {
          if (this.plugin.vars.browserCount == 0) {
            var url = 'http://localhost:' + this.plugin.options.port;

            require('./pluginUtil').log(this.plugin.vars.app + `Opening browser at ${url}`);

            this.plugin.vars.browserCount++;

            const opn = require('opn');

            opn(url);
          }
        }
      } catch (e) {
        console.log(e);
        compilation.errors.push('show browser window - ext-done: ' + e);
      }

      require('./pluginUtil').log(this.plugin.vars.app + `Completed ext-webpack-plugin processing`);
    });
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiRXh0V2VicGFja1BsdWdpbiIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsInBsdWdpbiIsIl9jb25zdHJ1Y3RvciIsImFwcGx5IiwiY29tcGlsZXIiLCJsb2d2IiwiaG9va3MiLCJjb25zb2xlIiwibG9nIiwidGhpc0NvbXBpbGF0aW9uIiwidGFwIiwiY29tcGlsYXRpb24iLCJ2YXJzIiwicGx1Z2luRXJyb3JzIiwibGVuZ3RoIiwiZXJyb3JzIiwicHVzaCIsIkVycm9yIiwiam9pbiIsImZyYW1ld29yayIsImFmdGVyQ29tcGlsZSIsIl9hZnRlckNvbXBpbGUiLCJfY29tcGlsYXRpb24iLCJnZW5Qcm9kRGF0YSIsImVudmlyb25tZW50IiwiZW1pdCIsInRhcEFzeW5jIiwiY2FsbGJhY2siLCJkb25lIiwicHJvZHVjdGlvbiIsInBhdGgiLCJmc3giLCJyaW1yYWYiLCJzeW5jIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJjd2QiLCJhcHBNb2R1bGVQYXRoIiwianMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsIm5ld0pzIiwicmVwbGFjZSIsIndyaXRlRmlsZVN5bmMiLCJlIiwiYnJvd3NlciIsIndhdGNoIiwiYnJvd3NlckNvdW50IiwidXJsIiwicG9ydCIsImFwcCIsIm9wbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFDQUEsT0FBTyxDQUFDLGlCQUFELENBQVA7O0FBQ2UsTUFBTUMsZ0JBQU4sQ0FBdUI7QUFDcENDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVO0FBQ25CLFNBQUtDLE1BQUwsR0FBY0osT0FBTyxDQUFFLGNBQUYsQ0FBUCxDQUF3QkssWUFBeEIsQ0FBcUNGLE9BQXJDLENBQWQ7QUFDRDs7QUFFREcsRUFBQUEsS0FBSyxDQUFDQyxRQUFELEVBQVc7QUFDZFAsSUFBQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QlEsSUFBeEIsQ0FBNkIsS0FBS0osTUFBTCxDQUFZ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Y0FBSSxLQUFLNUIsTUFBTCxDQUFZVyxJQUFaLENBQWlCbUMsWUFBakIsSUFBaUMsQ0FBckMsRUFBd0M7QUFDdEMsZ0JBQUlDLEdBQUcsR0FBRyxzQkFBc0IsS0FBSy9DLE1BQUwsQ0FBWUQsT0FBWixDQUFvQmlELElBQXBEOztBQUNBcEQsWUFBQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QlcsR0FBeEIsQ0FBNEIsS0FBS1AsTUFBTCxDQUFZVyxJQUFaLENBQWlCc0MsR0FBakIsR0FBd0Isc0JBQXFCRixHQUFJLEVBQTdFOztBQUNBLGlCQUFLL0MsTUFBTCxDQUFZVyxJQUFaLENBQWlCbUMsWUFBakI7O0FBQ0Esa0JBQU1JLEdBQUcsR0FBR3RELE9BQU8sQ0FBQyxLQUFELENBQW5COztBQUNBc0QsWUFBQUEsR0FBRyxDQUFDSCxHQUFELENBQUg7QUFDRDtBQUNGO0FBQ0YsT0FWRCxDQVdBLE9BQU9KLENBQVAsRUFBVTtBQUNSckMsUUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlvQyxDQUFaO0FBQ0FqQyxRQUFBQSxXQUFXLENBQUNJLE1BQVosQ0FBbUJDLElBQW5CLENBQXdCLHFDQUFxQzRCLENBQTdEO0FBQ0Q7O0FBQ0QvQyxNQUFBQSxPQUFPLENBQUMsY0FBRCxDQUFQLENBQXdCVyxHQUF4QixDQUE0QixLQUFLUCxNQUFMLENBQVlXLElBQVosQ0FBaUJzQyxHQUFqQixHQUF3Qix5Q0FBcEQ7QUFDRCxLQXhDRDtBQXlDRDs7QUF6Rm1DIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5yZXF1aXJlKCdAYmFiZWwvcG9seWZpbGwnKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXh0V2VicGFja1BsdWdpbiB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICB0aGlzLnBsdWdpbiA9IHJlcXVpcmUoYC4vcGx1Z2luVXRpbGApLl9jb25zdHJ1Y3RvcihvcHRpb25zKVxuICB9XG5cbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2KHRoaXMucGx1Z2luLm9wdGlvbnMsJ0ZVTkNUSU9OIGFwcGx5JylcbiAgICBpZiAoIWNvbXBpbGVyLmhvb2tzKSB7Y29uc29sZS5sb2coJ25vdCB3ZWJwYWNrIDQnKTtyZXR1cm59XG5cbiAgICBjb21waWxlci5ob29rcy50aGlzQ29tcGlsYXRpb24udGFwKGBleHQtdGhpcy1jb21waWxhdGlvbmAsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIHRoaXNDb21waWxhdGlvbicpXG4gICAgICBpZiAodGhpcy5wbHVnaW4udmFycy5wbHVnaW5FcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb21waWxhdGlvbi5lcnJvcnMucHVzaCggbmV3IEVycm9yKHRoaXMucGx1Z2luLnZhcnMucGx1Z2luRXJyb3JzLmpvaW4oXCJcIikpIClcbiAgICAgIH1cbiAgICB9KVxuICAgIGlmICh0aGlzLnBsdWdpbi52YXJzLnBsdWdpbkVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAoIHRoaXMucGx1Z2luLnZhcnMuZnJhbWV3b3JrID09ICdleHRqcycpIHtcbiAgICAgIGNvbXBpbGVyLmhvb2tzLmNvbXBpbGF0aW9uLnRhcChgZXh0LWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3YodGhpcy5wbHVnaW4ub3B0aW9ucywnSE9PSyBjb21waWxhdGlvbicpXG4gICAgICB9KVxuICAgICAgY29tcGlsZXIuaG9va3MuYWZ0ZXJDb21waWxlLnRhcCgnZXh0LWFmdGVyLWNvbXBpbGUnLCAoY29tcGlsYXRpb24pID0+IHtcbiAgICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIGFmdGVyQ29tcGlsZScpXG4gICAgICAgIHJlcXVpcmUoYC4vZXh0anNVdGlsYCkuX2FmdGVyQ29tcGlsZShjb21waWxhdGlvbiwgdGhpcy5wbHVnaW4udmFycywgdGhpcy5wbHVnaW4ub3B0aW9ucylcbiAgICAgIH0pXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY29tcGlsZXIuaG9va3MuY29tcGlsYXRpb24udGFwKGBleHQtY29tcGlsYXRpb25gLCAoY29tcGlsYXRpb24pID0+IHtcbiAgICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIGNvbXBpbGF0aW9uJylcbiAgICAgICAgcmVxdWlyZShgLi9wbHVnaW5VdGlsYCkuX2NvbXBpbGF0aW9uKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdGhpcy5wbHVnaW4udmFycywgdGhpcy5wbHVnaW4ub3B0aW9ucylcbiAgICAgIH0pXG4gICAgICBjb21waWxlci5ob29rcy5hZnRlckNvbXBpbGUudGFwKCdleHQtYWZ0ZXItY29tcGlsZScsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2KHRoaXMucGx1Z2luLm9wdGlvbnMsJ0hPT0sgYWZ0ZXJDb21waWxlJylcbiAgICAgICAgcmVxdWlyZShgLi9wbHVnaW5VdGlsYCkuX2FmdGVyQ29tcGlsZShjb21waWxlciwgY29tcGlsYXRpb24sIHRoaXMucGx1Z2luLnZhcnMsIHRoaXMucGx1Z2luLm9wdGlvbnMpXG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmKCh0aGlzLnBsdWdpbi5vcHRpb25zLmdlblByb2REYXRhID09IHRydWUgJiYgdGhpcy5wbHVnaW4ub3B0aW9ucy5lbnZpcm9ubWVudCA9PSAncHJvZHVjdGlvbicpIHx8XG4gICAgICAgKHRoaXMucGx1Z2luLm9wdGlvbnMuZ2VuUHJvZERhdGEgPT0gZmFsc2UgJiYgdGhpcy5wbHVnaW4ub3B0aW9ucy5lbnZpcm9ubWVudCAhPSAncHJvZHVjdGlvbicpKVxuICAgIHtcbiAgICAgIGNvbXBpbGVyLmhvb2tzLmVtaXQudGFwQXN5bmMoYGV4dC1lbWl0YCwgKGNvbXBpbGF0aW9uLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2KHRoaXMucGx1Z2luLm9wdGlvbnMsJ0hPT0sgZW1pdCcpXG4gICAgICAgIHJlcXVpcmUoYC4vcGx1Z2luVXRpbGApLmVtaXQoY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB0aGlzLnBsdWdpbi52YXJzLCB0aGlzLnBsdWdpbi5vcHRpb25zLCBjYWxsYmFjaylcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29tcGlsZXIuaG9va3MuZG9uZS50YXAoYGV4dC1kb25lYCwgKCkgPT4ge1xuICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndih0aGlzLnBsdWdpbi5vcHRpb25zLCdIT09LIGRvbmUnKVxuXG4gICAgICBpZiAodGhpcy5wbHVnaW4udmFycy5wcm9kdWN0aW9uICYmICF0aGlzLnBsdWdpbi5vcHRpb25zLmdlblByb2REYXRhICYmIHRoaXMucGx1Z2luLm9wdGlvbnMuZnJhbWV3b3JrID09ICdhbmd1bGFyJykge1xuICAgICAgICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG4gICAgICAgIGNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLWV4dHJhJylcbiAgICAgICAgdmFyIHJpbXJhZiA9IHJlcXVpcmUoXCJyaW1yYWZcIik7XG4gICAgICAgIHJpbXJhZi5zeW5jKHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBgc3JjL2FwcC9leHQtYW5ndWxhci1wcm9kYCkpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGFwcE1vZHVsZVBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJ3NyYy9hcHAvYXBwLm1vZHVsZS50cycpXG4gICAgICAgICAgdmFyIGpzID0gZnN4LnJlYWRGaWxlU3luYyhhcHBNb2R1bGVQYXRoKS50b1N0cmluZygpXG4gICAgICAgICAgdmFyIG5ld0pzID0ganMucmVwbGFjZShcbiAgICAgICAgICAgIGBpbXBvcnQgeyBFeHRBbmd1bGFyTW9kdWxlIH0gZnJvbSAnLi9leHQtYW5ndWxhci1wcm9kL2V4dC1hbmd1bGFyLm1vZHVsZSdgLFxuICAgICAgICAgICAgYGltcG9ydCB7IEV4dEFuZ3VsYXJNb2R1bGUgfSBmcm9tICdAc2VuY2hhL2V4dC1hbmd1bGFyJ2BcbiAgICAgICAgICApO1xuICAgICAgICAgIGZzeC53cml0ZUZpbGVTeW5jKGFwcE1vZHVsZVBhdGgsIG5ld0pzLCAndXRmLTgnLCAoKT0+e3JldHVybn0pXG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdyZXBsYWNlIEV4dEFuZ3VsYXJNb2R1bGUgLSBleHQtZG9uZTogJyArIGUpXG4gICAgICAgICAgcmV0dXJuIFtdXG4gICAgICAgIH1cbiAgICAgIH0gXG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmKHRoaXMucGx1Z2luLm9wdGlvbnMuYnJvd3NlciA9PSB0cnVlICYmIHRoaXMucGx1Z2luLm9wdGlvbnMud2F0Y2ggPT0gJ3llcycgJiYgdGhpcy5wbHVnaW4udmFycy5wcm9kdWN0aW9uID09IGZhbHNlKSB7XG4gICAgICAgICAgaWYgKHRoaXMucGx1Z2luLnZhcnMuYnJvd3NlckNvdW50ID09IDApIHtcbiAgICAgICAgICAgIHZhciB1cmwgPSAnaHR0cDovL2xvY2FsaG9zdDonICsgdGhpcy5wbHVnaW4ub3B0aW9ucy5wb3J0XG4gICAgICAgICAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2codGhpcy5wbHVnaW4udmFycy5hcHAgKyBgT3BlbmluZyBicm93c2VyIGF0ICR7dXJsfWApXG4gICAgICAgICAgICB0aGlzLnBsdWdpbi52YXJzLmJyb3dzZXJDb3VudCsrXG4gICAgICAgICAgICBjb25zdCBvcG4gPSByZXF1aXJlKCdvcG4nKVxuICAgICAgICAgICAgb3BuKHVybClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdzaG93IGJyb3dzZXIgd2luZG93IC0gZXh0LWRvbmU6ICcgKyBlKVxuICAgICAgfVxuICAgICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9nKHRoaXMucGx1Z2luLnZhcnMuYXBwICsgYENvbXBsZXRlZCBleHQtd2VicGFjay1wbHVnaW4gcHJvY2Vzc2luZ2ApXG4gICAgfSlcbiAgfVxufVxuIl19