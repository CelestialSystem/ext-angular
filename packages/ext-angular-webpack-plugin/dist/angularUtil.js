"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getValidateOptions = getValidateOptions;
exports.getDefaultOptions = getDefaultOptions;
exports.getDefaultVars = getDefaultVars;
exports.extractFromSource = extractFromSource;

function getValidateOptions() {
  return {
    "type": "object",
    "properties": {
      "framework": {
        "type": ["string"]
      },
      "port": {
        "type": ["integer"]
      },
      "emit": {
        "type": ["boolean"]
      },
      "browser": {
        "type": ["boolean"]
      },
      "watch": {
        "type": ["string"]
      },
      "profile": {
        "type": ["string"]
      },
      "environment": {
        "type": ["string"]
      },
      "verbose": {
        "type": ["string"]
      },
      "theme": {
        "type": ["string"]
      },
      "toolkit": {
        "type": ["string"]
      },
      "packages": {
        "type": ["string", "array"]
      }
    },
    "additionalProperties": false // "errorMessage": {
    //   "option": "should be {Boolean} (https:/github.com/org/repo#anchor)"
    // }

  };
}

function getDefaultOptions() {
  return {
    port: 1962,
    emit: true,
    browser: true,
    watch: 'yes',
    profile: '',
    environment: 'development',
    verbose: 'no',
    toolkit: 'modern',
    packages: null
  };
}

function getDefaultVars() {
  return {
    watchStarted: false,
    firstTime: true,
    firstCompile: true,
    browserCount: 0,
    manifest: null,
    extPath: 'ext-angular',
    pluginErrors: [],
    deps: [],
    rebuild: true
  };
}

function toXtype(str) {
  return str.toLowerCase().replace(/_/g, '-');
}

function extractFromSource(module, options, compilation) {
  try {
    var js = module._source._value;

    const logv = require('./pluginUtil').logv;

    logv(options, 'FUNCTION extractFromSource');
    var statements = [];

    if (module.resource.match(/\.html$/)) {
      var generate = require("@babel/generator").default;

      var parse = require("babylon").parse;

      var traverse = require("ast-traverse");

      var ast = parse(js, {
        plugins: ['typescript', 'flow', 'doExpressions', 'objectRestSpread', 'classProperties', 'exportDefaultFrom', 'exportExtensions', 'asyncGenerators', 'functionBind', 'functionSent', 'dynamicImport'],
        sourceType: 'module'
      });

      function addType(argNode) {
        var type;

        if (argNode.type === 'StringLiteral') {
          var xtype = toXtype(argNode.value);

          if (xtype != 'extreact') {
            type = {
              xtype: toXtype(argNode.value)
            };
          }
        } else {
          type = {
            xclass: js.slice(argNode.start, argNode.end)
          };
        }

        if (type != undefined) {
          let config = JSON.stringify(type);
          statements.push(`Ext.create(${config})`);
        }
      }

      traverse(ast, {
        pre: function (node) {
          if (node.type === 'CallExpression' && node.callee && node.callee.object && node.callee.object.name === 'Ext') {
            statements.push(generate(node).code);
          }

          if (node.type === 'StringLiteral') {
            let code = node.value;

            for (var i = 0; i < code.length; ++i) {
              if (code.charAt(i) == '<') {
                if (resource.match(/\.html$/) && code.substr(i, 4) == '<!==') {
                  i += 4;
                  i += code.substr(i).indexOf('-->') + 3;
                  continue;
                } else if (code.charAt(i + 1) !== '/') {
                  var start = code.substring(i);
                  var end = start.indexOf(' ');

                  if (end >= 0) {
                    var xtype = start.substring(1, end); // TODO add condition to check for ext componenets only.
                    // Donot need toXtype here since it can safely be assumend the selector is same as xtype for all components defined.

                    var type = {
                      xtype: toXtype(xtype)
                    };
                    let config = JSON.stringify(type);
                    statements.push(`Ext.create(${config})`);
                  }
                }
              } // Probably not required


              if (node.type == 'VariableDeclarator' && node.init && node.init.type == 'CallExpression' && node.init.callee) {
                if (node.init.callee.name == 'reactify') {
                  for (let i = 0; i < node.init.arguments.length; i++) {
                    const valueNode = node.init.arguments[i];
                    if (!valueNode) continue;
                    addType(valueNode);
                  }
                }
              }
            }
          }
        }
      });
    }

    console.log('$$$$$$$$$$$$$$$4 statements are');
    console.log(statements);
    return statements;
  } catch (e) {
    console.log(e);
    compilation.errors.push('extractFromSource: ' + e);
    return [];
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hbmd1bGFyVXRpbC5qcyJdLCJuYW1lcyI6WyJnZXRWYWxpZGF0ZU9wdGlvbnMiLCJnZXREZWZhdWx0T3B0aW9ucyIsInBvcnQiLCJlbWl0IiwiYnJvd3NlciIsIndhdGNoIiwicHJvZmlsZSIsImVudmlyb25tZW50IiwidmVyYm9zZSIsInRvb2xraXQiLCJwYWNrYWdlcyIsImdldERlZmF1bHRWYXJzIiwid2F0Y2hTdGFydGVkIiwiZmlyc3RUaW1lIiwiZmlyc3RDb21waWxlIiwiYnJvd3NlckNvdW50IiwibWFuaWZlc3QiLCJleHRQYXRoIiwicGx1Z2luRXJyb3JzIiwiZGVwcyIsInJlYnVpbGQiLCJ0b1h0eXBlIiwic3RyIiwidG9Mb3dlckNhc2UiLCJyZXBsYWNlIiwiZXh0cmFjdEZyb21Tb3VyY2UiLCJtb2R1bGUiLCJvcHRpb25zIiwiY29tcGlsYXRpb24iLCJqcyIsIl9zb3VyY2UiLCJfdmFsdWUiLCJsb2d2IiwicmVxdWlyZSIsInN0YXRlbWVudHMiLCJyZXNvdXJjZSIsIm1hdGNoIiwiZ2VuZXJhdGUiLCJkZWZhdWx0IiwicGFyc2UiLCJ0cmF2ZXJzZSIsImFzdCIsInBsdWdpbnMiLCJzb3VyY2VUeXBlIiwiYWRkVHlwZSIsImFyZ05vZGUiLCJ0eXBlIiwieHR5cGUiLCJ2YWx1ZSIsInhjbGFzcyIsInNsaWNlIiwic3RhcnQiLCJlbmQiLCJ1bmRlZmluZWQiLCJjb25maWciLCJKU09OIiwic3RyaW5naWZ5IiwicHVzaCIsInByZSIsIm5vZGUiLCJjYWxsZWUiLCJvYmplY3QiLCJuYW1lIiwiY29kZSIsImkiLCJsZW5ndGgiLCJjaGFyQXQiLCJzdWJzdHIiLCJpbmRleE9mIiwic3Vic3RyaW5nIiwiaW5pdCIsImFyZ3VtZW50cyIsInZhbHVlTm9kZSIsImNvbnNvbGUiLCJsb2ciLCJlIiwiZXJyb3JzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztBQUVPLFNBQVNBLGtCQUFULEdBQThCO0FBQ25DLFNBQU87QUFDTCxZQUFRLFFB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QSxXQUFXLENBQUNnRCxNQUFaLENBQW1CbkIsSUFBbkIsQ0FBd0Isd0JBQXdCa0IsQ0FBaEQ7QUFDQSxXQUFPLEVBQVA7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCJcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFZhbGlkYXRlT3B0aW9ucygpIHtcbiAgcmV0dXJuIHtcbiAgICBcInR5cGVcIjogXCJvYmplY3RcIixcbiAgICBcInByb3BlcnRpZXNcIjoge1xuICAgICAgXCJmcmFtZXdvcmtcIjogICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwicG9ydFwiOiAgICAgICAge1widHlwZVwiOiBbIFwiaW50ZWdlclwiIF19LFxuICAgICAgXCJlbWl0XCI6ICAgICAgICB7XCJ0eXBlXCI6IFsgXCJib29sZWFuXCIgXX0sXG4gICAgICBcImJyb3dzZXJcIjogICAgIHtcInR5cGVcIjogWyBcImJvb2xlYW5cIiBdfSxcbiAgICAgIFwid2F0Y2hcIjogICAgICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX0sXG4gICAgICBcInByb2ZpbGVcIjogICAgIHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJlbnZpcm9ubWVudFwiOiB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwidmVyYm9zZVwiOiAgICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX0sXG4gICAgICBcInRoZW1lXCI6ICAgICAgIHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJ0b29sa2l0XCI6ICAgICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwicGFja2FnZXNcIjogICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIsIFwiYXJyYXlcIiBdfVxuICAgIH0sXG4gICAgXCJhZGRpdGlvbmFsUHJvcGVydGllc1wiOiBmYWxzZVxuICAgIC8vIFwiZXJyb3JNZXNzYWdlXCI6IHtcbiAgICAvLyAgIFwib3B0aW9uXCI6IFwic2hvdWxkIGJlIHtCb29sZWFufSAoaHR0cHM6L2dpdGh1Yi5jb20vb3JnL3JlcG8jYW5jaG9yKVwiXG4gICAgLy8gfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0T3B0aW9ucygpIHtcbiAgcmV0dXJuIHtcbiAgICBwb3J0OiAxOTYyLFxuICAgIGVtaXQ6IHRydWUsXG4gICAgYnJvd3NlcjogdHJ1ZSxcbiAgICB3YXRjaDogJ3llcycsXG4gICAgcHJvZmlsZTogJycsIFxuICAgIGVudmlyb25tZW50OiAnZGV2ZWxvcG1lbnQnLCBcbiAgICB2ZXJib3NlOiAnbm8nLFxuICAgIHRvb2xraXQ6ICdtb2Rlcm4nLFxuICAgIHBhY2thZ2VzOiBudWxsXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERlZmF1bHRWYXJzKCkge1xuICByZXR1cm4ge1xuICAgIHdhdGNoU3RhcnRlZCA6IGZhbHNlLFxuICAgIGZpcnN0VGltZSA6IHRydWUsXG4gICAgZmlyc3RDb21waWxlOiB0cnVlLFxuICAgIGJyb3dzZXJDb3VudCA6IDAsXG4gICAgbWFuaWZlc3Q6IG51bGwsXG4gICAgZXh0UGF0aDogJ2V4dC1hbmd1bGFyJyxcbiAgICBwbHVnaW5FcnJvcnM6IFtdLFxuICAgIGRlcHM6IFtdLFxuICAgIHJlYnVpbGQ6IHRydWVcbiAgfVxufVxuXG5mdW5jdGlvbiB0b1h0eXBlKHN0cikge1xuICByZXR1cm4gc3RyLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXy9nLCAnLScpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHRyYWN0RnJvbVNvdXJjZShtb2R1bGUsIG9wdGlvbnMsIGNvbXBpbGF0aW9uKSB7XG4gIHRyeSB7XG4gICAgdmFyIGpzID0gbW9kdWxlLl9zb3VyY2UuX3ZhbHVlXG4gICAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcbiAgICBsb2d2KG9wdGlvbnMsJ0ZVTkNUSU9OIGV4dHJhY3RGcm9tU291cmNlJylcbiAgICB2YXIgc3RhdGVtZW50cyA9IFtdXG4gICAgaWYgKG1vZHVsZS5yZXNvdXJjZS5tYXRjaCgvXFwuaHRtbCQvKSkge1xuXG4gICAgICB2YXIgZ2VuZXJhdGUgPSByZXF1aXJlKFwiQGJhYmVsL2dlbmVyYXRvclwiKS5kZWZhdWx0XG4gICAgICB2YXIgcGFyc2UgPSByZXF1aXJlKFwiYmFieWxvblwiKS5wYXJzZVxuICAgICAgdmFyIHRyYXZlcnNlID0gcmVxdWlyZShcImFzdC10cmF2ZXJzZVwiKVxuXG4gICAgICB2YXIgYXN0ID0gcGFyc2UoanMsIHtcbiAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgICd0eXBlc2NyaXB0JyxcbiAgICAgICAgICAnZmxvdycsXG4gICAgICAgICAgJ2RvRXhwcmVzc2lvbnMnLFxuICAgICAgICAgICdvYmplY3RSZXN0U3ByZWFkJyxcbiAgICAgICAgICAnY2xhc3NQcm9wZXJ0aWVzJyxcbiAgICAgICAgICAnZXhwb3J0RGVmYXVsdEZyb20nLFxuICAgICAgICAgICdleHBvcnRFeHRlbnNpb25zJyxcbiAgICAgICAgICAnYXN5bmNHZW5lcmF0b3JzJyxcbiAgICAgICAgICAnZnVuY3Rpb25CaW5kJyxcbiAgICAgICAgICAnZnVuY3Rpb25TZW50JyxcbiAgICAgICAgICAnZHluYW1pY0ltcG9ydCdcbiAgICAgICAgXSxcbiAgICAgICAgc291cmNlVHlwZTogJ21vZHVsZSdcbiAgICAgIH0pXG5cbiAgICAgIGZ1bmN0aW9uIGFkZFR5cGUoYXJnTm9kZSkge1xuICAgICAgICB2YXIgdHlwZVxuXG4gICAgICAgIGlmIChhcmdOb2RlLnR5cGUgPT09ICdTdHJpbmdMaXRlcmFsJykge1xuICAgICAgICAgIHZhciB4dHlwZSA9IHRvWHR5cGUoYXJnTm9kZS52YWx1ZSlcblxuICAgICAgICAgIGlmICh4dHlwZSAhPSAnZXh0cmVhY3QnKSB7XG4gICAgICAgICAgICB0eXBlID0ge1xuICAgICAgICAgICAgICB4dHlwZTogdG9YdHlwZShhcmdOb2RlLnZhbHVlKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0eXBlID0ge1xuICAgICAgICAgICAgeGNsYXNzOiBqcy5zbGljZShhcmdOb2RlLnN0YXJ0LCBhcmdOb2RlLmVuZClcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZSAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBsZXQgY29uZmlnID0gSlNPTi5zdHJpbmdpZnkodHlwZSlcbiAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2goYEV4dC5jcmVhdGUoJHtjb25maWd9KWApXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgdHJhdmVyc2UoYXN0LCB7XG4gICAgICAgIHByZTogZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nICYmIG5vZGUuY2FsbGVlICYmIG5vZGUuY2FsbGVlLm9iamVjdCAmJiBub2RlLmNhbGxlZS5vYmplY3QubmFtZSA9PT0gJ0V4dCcpIHtcbiAgICAgICAgICAgIHN0YXRlbWVudHMucHVzaChnZW5lcmF0ZShub2RlKS5jb2RlKVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZihub2RlLnR5cGUgPT09ICdTdHJpbmdMaXRlcmFsJykge1xuICAgICAgICAgICAgbGV0IGNvZGUgPSBub2RlLnZhbHVlXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvZGUubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgaWYgKGNvZGUuY2hhckF0KGkpID09ICc8Jykge1xuICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZS5tYXRjaCgvXFwuaHRtbCQvKSAmJiBjb2RlLnN1YnN0cihpLCA0KSA9PSAnPCE9PScpIHtcbiAgICAgICAgICAgICAgICAgIGkgKz0gNFxuICAgICAgICAgICAgICAgICAgaSArPSBjb2RlLnN1YnN0cihpKS5pbmRleE9mKCctLT4nKSArIDNcbiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2RlLmNoYXJBdChpKzEpICE9PSAnLycpIHtcbiAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGNvZGUuc3Vic3RyaW5nKGkpXG4gICAgICAgICAgICAgICAgICB2YXIgZW5kID0gc3RhcnQuaW5kZXhPZignICcpXG4gICAgICAgICAgICAgICAgICBpZiAoZW5kID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHh0eXBlID0gc3RhcnQuc3Vic3RyaW5nKDEsIGVuZClcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgY29uZGl0aW9uIHRvIGNoZWNrIGZvciBleHQgY29tcG9uZW5ldHMgb25seS5cbiAgICAgICAgICAgICAgICAgICAgLy8gRG9ub3QgbmVlZCB0b1h0eXBlIGhlcmUgc2luY2UgaXQgY2FuIHNhZmVseSBiZSBhc3N1bWVuZCB0aGUgc2VsZWN0b3IgaXMgc2FtZSBhcyB4dHlwZSBmb3IgYWxsIGNvbXBvbmVudHMgZGVmaW5lZC5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSB7IHh0eXBlOiB0b1h0eXBlKHh0eXBlKSB9XG4gICAgICAgICAgICAgICAgICAgIGxldCBjb25maWcgPSBKU09OLnN0cmluZ2lmeSh0eXBlKVxuICAgICAgICAgICAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2goYEV4dC5jcmVhdGUoJHtjb25maWd9KWApXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIFByb2JhYmx5IG5vdCByZXF1aXJlZFxuICAgICAgICAgICAgICBpZiAobm9kZS50eXBlID09ICdWYXJpYWJsZURlY2xhcmF0b3InICYmIG5vZGUuaW5pdCAmJiBub2RlLmluaXQudHlwZSA9PSAnQ2FsbEV4cHJlc3Npb24nICYmIG5vZGUuaW5pdC5jYWxsZWUpIHtcbiAgICAgICAgICAgICAgICBpZiAobm9kZS5pbml0LmNhbGxlZS5uYW1lID09ICdyZWFjdGlmeScpIHtcbiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5pbml0LmFyZ3VtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZU5vZGUgPSBub2RlLmluaXQuYXJndW1lbnRzW2ldXG4gICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWVOb2RlKSBjb250aW51ZVxuICAgICAgICAgICAgICAgICAgICBhZGRUeXBlKHZhbHVlTm9kZSlcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZygnJCQkJCQkJCQkJCQkJCQkNCBzdGF0ZW1lbnRzIGFyZScpXG4gICAgY29uc29sZS5sb2coc3RhdGVtZW50cylcbiAgICByZXR1cm4gc3RhdGVtZW50c1xuICB9XG4gIGNhdGNoKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdleHRyYWN0RnJvbVNvdXJjZTogJyArIGUpXG4gICAgcmV0dXJuIFtdXG4gIH1cbn1cbiJdfQ==